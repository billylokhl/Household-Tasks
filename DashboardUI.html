<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      body { background-color: #121212; color: #E0E0E0; font-family: sans-serif; padding: 20px; overflow: hidden; }
      .header { display: flex; gap: 15px; margin-bottom: 20px; }
      .card { background: #1e1e1e; flex: 1; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #333; }
      .card-val { font-size: 32px; font-weight: bold; margin-top: 5px; }
      #chart_div { width: 1000px; height: 500px; background: #1e1e1e; border-radius: 10px; border: 1px solid #333; padding: 10px; }
      .loader { text-align: center; margin-top: 100px; color: #4285f4; }
    </style>
  </head>
  <body>
    <div id="loading" class="loader"><h2>Crunching Data...</h2></div>
    
    <div id="content" style="display:none">
      <div class="header">
        <div class="card"><div>Total (14-Day)</div><div class="card-val" id="totalAll">0</div></div>
        <div class="card"><div style="color:#FF5252">Ownership üê∑</div><div class="card-val" id="totalP" style="color:#FF5252">0</div></div>
        <div class="card"><div style="color:#FFAB40">Ownership üê±</div><div class="card-val" id="totalC" style="color:#FFAB40">0</div></div>
      </div>
      <div id="chart_div"></div>
    </div>

    <script>
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(init);

      function init() {
        google.script.run.withSuccessHandler(draw).getDashboardData();
      }

      function draw(data) {
        if (!data || data.error) {
          document.getElementById('loading').innerHTML = "<h2 style='color:red'>Error: " + (data ? data.error : "No Data") + "</h2>";
          return;
        }
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('totalAll').innerText = data.totalP + data.totalC;
        document.getElementById('totalP').innerText = data.totalP;
        document.getElementById('totalC').innerText = data.totalC;

        var table = new google.visualization.DataTable();
        table.addColumn('string', 'Date');
        table.addColumn('number', 'Ownership üê∑');
        table.addColumn({type: 'number', role: 'annotation'});
        table.addColumn('number', 'Ownership üê±');
        table.addColumn({type: 'number', role: 'annotation'});

        // Re-reverse the data to show past -> present (Left to Right)
        var chartRows = data.rows.map(r => [r[0], r[1], r[1]||null, r[2], r[2]||null]);
        table.addRows(chartRows);

        var options = {
          title: 'Incident Count (Trailing 14-Day Window)',
          titleTextStyle: { color: '#FFF', fontSize: 18 },
          backgroundColor: 'transparent',
          colors: ['#FF5252', '#FFAB40'],
          legend: { position: 'top', textStyle: { color: '#CCC' } },
          chartArea: { width: '90%', height: '70%' },
          annotations: { textStyle: { color: '#FFF', fontSize: 11, bold: true } },
          vAxis: { textStyle: { color: '#888' }, gridlines: { color: '#333' }, format: '#' },
          hAxis: { textStyle: { color: '#888', fontSize: 10 }, slantedText: true }
        };

        new google.visualization.ColumnChart(document.getElementById('chart_div')).draw(table, options);
      }
    </script>
  </body>
</html>