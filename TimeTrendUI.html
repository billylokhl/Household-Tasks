<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root { --bg: #ffffff; --text: #333333; --border: #e2e8f0; }
    body.dark-mode { --bg: #0f172a; --text: #f1f5f9; --border: #334155; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; margin: 0; box-sizing: border-box; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
    .btn-group { display: flex; gap: 10px; }
    .btn { padding: 12px 24px; cursor: pointer; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; font-size: 18px; }
    .btn.active { background: #3b82f6; color: white; border-color: #2563eb; }
    #chart_div { flex-grow: 1; min-height: 400px; width: 100%; }
    /* Fix for Google's own tooltip container */
    .google-visualization-tooltip { border: none !important; background: transparent !important; box-shadow: none !important; }

    .chart-tooltip { padding: 12px; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-family: sans-serif; min-width: 200px; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5); }
    .chart-tooltip table { width: 100%; font-size: 12px; border-collapse: collapse; }
    .chart-tooltip td { padding: 2px 0; color: var(--text); }
    .chart-val { text-align: right; padding-left: 10px; }
    .chart-total { border-top: 1px solid var(--border); }
    .chart-pt { padding-top: 8px; }
  </style>
</head>
<body id="body">
  <div class="header">
    <div class="btn-group">
      <button id="btnA" class="btn active" onclick="switchOwner('A')">üê∑</button>
      <button id="btnB" class="btn" onclick="switchOwner('B')">üê±</button>
    </div>
    <div class="btn-group" style="align-items: center;">
      <label style="font-size: 14px; margin-right: 5px;">Moving Daily Average Window:</label>
      <input type="number" id="maWindow" value="28" min="2" max="29" style="width: 60px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text);" onchange="refreshData()" />
      <span style="font-size: 14px; margin-left: 3px;">days</span>
      <label style="font-size: 14px; margin-left: 15px; display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="weekendOnly" checked onchange="refreshData()" style="margin-right: 5px; cursor: pointer;" />
        Weekend Only
      </label>
      <label style="font-size: 14px; margin-left: 15px; margin-right: 5px;">Days to Look Ahead:</label>
      <input type="number" id="daysAhead" value="7" min="0" max="30" style="width: 60px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text);" onchange="refreshData()" />
    </div>
    <div class="btn-group">
      <button class="btn" style="font-size:14px" onclick="toggleDebugLog()">üîç Debug Log</button>
      <button class="btn" style="font-size:14px" onclick="toggleTheme()">üåì Theme</button>
    </div>
  </div>
  <div id="chart_div"></div>
  <div id="task_details_container" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px; padding-right: 15px; overflow-y: auto; height: 150px;">
    <p style="color: var(--text); opacity: 0.7;">Hover over a bar to see task details.</p>
  </div>
  <div id="debug_log" style="display:none; margin-top: 10px; padding: 10px; background: #eee; color: #333; font-family: monospace; font-size: 11px; height: 150px; overflow-y: scroll; border: 1px solid #ccc;">
    <div style="color: #999;">Step 1: Page loaded, waiting for scripts...</div>
  </div>
  <script>
    // IMMEDIATE TEST - Does ANY JavaScript work?
    try {
      document.getElementById('debug_log').innerHTML = '<div style="color:green;">‚úÖ JavaScript IS working! Initializing...</div>';
    } catch(e) {
      alert('JavaScript Error: ' + e.message);
    }

    // GRANULAR STATUS LOGGING
    function updateStatus(msg, color = '#333') {
      try {
        const logDiv = document.getElementById('debug_log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
      } catch(e) {
        console.error('updateStatus failed:', e);
      }
    }

    updateStatus('Step 2: JavaScript executing...', 'blue');

    // Try loading Google Charts with error handling
    try {
      if (typeof google === 'undefined') {
        updateStatus('‚ö†Ô∏è WARNING: Google Charts library not loaded. Skipping chart, will show data only.', 'orange');
      } else {
        google.charts.load('current', {'packages':['corechart']});
        updateStatus('Step 3: Google Charts load requested...', 'blue');
      }
    } catch(e) {
      updateStatus('‚ùå ERROR loading Google Charts: ' + e.message, 'red');
    }

    let allRes = null, currentOwner = 'A', isDarkMode = false;

    function refreshData() {
      const maWindow = parseInt(document.getElementById('maWindow').value) || 30;
      const weekendOnly = document.getElementById('weekendOnly').checked;
      const daysAhead = parseInt(document.getElementById('daysAhead').value) || 0;
      updateStatus(`Refreshing data with MA window: ${maWindow} days, Weekend Only: ${weekendOnly}, Days Ahead: ${daysAhead}...`, 'blue');
      init();
    }

    function init() {
      updateStatus('Step 4: init() function called!', 'green');
      const maWindow = parseInt(document.getElementById('maWindow').value) || 30;
      const weekendOnly = document.getElementById('weekendOnly').checked;
      const daysAhead = parseInt(document.getElementById('daysAhead').value) || 0;
      updateStatus(`Step 5: Sending request to server (getTimeSpentData) with MA=${maWindow}, Weekend Only=${weekendOnly}, Days Ahead=${daysAhead}...`, 'blue');

      google.script.run
        .withSuccessHandler(res => {
           updateStatus('Step 6: Server response received!', 'green');
           console.log('Full response object:', res);

           // Render Logs FIRST
           if (res.logs && res.logs.length > 0) {
               updateStatus(`Step 7: Processing ${res.logs.length} log entries...`, 'blue');
               const logHtml = res.logs.map(l => `<div>${l}</div>`).join('');
               document.getElementById('debug_log').innerHTML = `<strong>üìã Execution Logs (${res.logs.length} entries):</strong><br/>` + logHtml;
           } else {
               updateStatus('‚ö†Ô∏è Step 7: No logs returned from server', 'orange');
           }

           if (res.error) {
               updateStatus(`‚ùå ERROR from server: ${res.error}`, 'red');
               document.getElementById('chart_div').innerHTML = "<strong style='color:red'>Error: " + res.error + "</strong>";
               return;
           }

           updateStatus('Step 8: Data validated, preparing chart...', 'green');
           allRes = res;
           drawChart();
           updateStatus('Step 9: Chart drawn successfully! ‚úÖ', 'green');
        })
        .withFailureHandler(err => {
           updateStatus(`‚ùå FAILURE: Server call failed -

      // Check if Google Charts is available
      if (typeof google === 'undefined' || !google.visualization) {
        updateStatus('‚ö†Ô∏è Google Charts not available, showing data as text', 'orange');
        document.getElementById('chart_div').innerHTML = '<pre>' + JSON.stringify(allRes, null, 2) + '</pre>';
        return;
      }${err.message}`, 'red');
           console.error('Full error:', err);
           document.getElementById('chart_div').innerHTML = "<strong style='color:red'>Failed to load data. Check debug log.</strong>";
        })
        .getTimeSpentData(maWindow, weekendOnly, daysAhead);
    }

    function switchOwner(owner) {
      if (currentOwner === owner) return;
      currentOwner = owner;

      // Update button visual state
      const btnA = document.getElementById('btnA');
      const btnB = document.getElementById('btnB');

      if (owner === 'A') {
         btnA.classList.add('active');
         btnB.classList.remove('active');
      } else {
         btnA.classList.remove('active');
         btnB.classList.add('active');
      }

      // Re-draw the chart with new owner's data
      drawChart();
    }

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.getElementById('body').classList.toggle('dark-mode', isDarkMode);
      // Re-draw chart to update axes colors (client-side only now)
      drawChart();
    }

    function toggleDebugLog() {
      const logDiv = document.getElementById('debug_log');
      const taskDetailsContainer = document.getElementById('task_details_container');

      if (logDiv.style.display === 'none') {
        logDiv.style.display = 'block';
        taskDetailsContainer.style.display = 'none';
      } else {
        logDiv.style.display = 'none';
        taskDetailsContainer.style.display = 'block';
      }
    }

    function drawChart() {
      if (!allRes) {
        updateStatus('‚ö†Ô∏è drawChart() called but no data available', 'orange');
        return;
      }

      updateStatus('Drawing chart with data...', 'blue');

      const dataSet = currentOwner === 'A' ? allRes.dataA : allRes.dataB;
      const detailsSet = currentOwner === 'A' ? allRes.detailsA : allRes.detailsB;
      const categories = currentOwner === 'A' ? allRes.catsA : allRes.catsB;

      const data = google.visualization.arrayToDataTable(dataSet);
      const textColor = isDarkMode ? '#cbd5e1' : '#334155';
      const majorColor = isDarkMode ? '#94a3b8' : '#64748b'; // Thick/Dark for labeled
      const minorColor = isDarkMode ? '#1e293b' : '#e2e8f0'; // Thin/Light for unlabeled

      // Build series configuration - all categories as bars except last one (MA) as line
      const seriesConfig = {};
      const numCategories = categories.length;
      const todayIndex = allRes.todayIndex || -1; // Index where today ends

      for (let i = 0; i < numCategories; i++) {
        seriesConfig[i] = { type: 'bars' };
      }
      // Last series is the moving average line
      seriesConfig[numCategories] = { type: 'line', lineWidth: 3, pointSize: 0, color: '#f59e0b', lineDashStyle: [4, 4] };

      const options = {
        seriesType: 'bars',
        series: seriesConfig,
        isStacked: true,
        backgroundColor: 'transparent',
        chartArea: { width: '92%', height: '65%', left: 60, right: 20, bottom: 120 },
        legend: { position: 'bottom', maxLines: 3, textStyle: { color: textColor, fontSize: 11 } },
        hAxis: { textStyle: { color: textColor, fontSize: 10 }, slantedText: true, slantedTextAngle: 45 },
        vAxis: {
            title: 'Minutes',
            textStyle: { color: textColor },
            titleTextStyle: { color: textColor },
            gridlines: { color: majorColor },
            minorGridlines: { color: minorColor, count: 1 }
        },
        tooltip: { isHtml: true, trigger: 'both' }
      };

      const chart = new google.visualization.ComboChart(document.getElementById('chart_div'));

      google.visualization.events.addListener(chart, 'select', () => {
        const selection = chart.getSelection();
        if (selection.length > 0) {
           const e = selection[0];
           if (e.row == null || e.column == null) return;

           const dateLabel = data.getValue(e.row, 0);
           // Account for 3 columns per category (value, tooltip, style)
           const catIndex = Math.floor((e.column - 1) / 3);

           if (catIndex >= 0 && catIndex < categories.length) {
              const category = categories[catIndex];
              showTaskDetails(dateLabel, category, detailsSet);
           }
        }
      });

      chart.draw(data, options);
    }

    function showTaskDetails(date, category, details) {
        const container = document.getElementById('task_details_container');
        const dayData = details[date];
        const tasks = (dayData && dayData[category]) ? dayData[category] : [];

        let html = `<div style="font-weight: bold; margin-bottom: 8px;">${category} (${date})</div>`;
        if (tasks.length === 0) {
            html += '<div style="font-size: 13px;">No tasks recorded.</div>';
        } else {
            tasks.sort((a,b) => b.mins - a.mins);
            html += `<table style="width:100%; font-size:12px;"><thead><tr style="border-bottom: 2px solid var(--border);"><th style="text-align: left; padding: 4px;">Task</th><th style="text-align: center; width: 60px;">Mins</th></tr></thead><tbody>`;
            tasks.forEach(t => {
               html += `<tr style="border-bottom: 1px solid var(--border);"><td style="padding: 4px; word-wrap: break-word;">${t.task}</td><td style="padding: 4px; text-align: right;">${t.mins}</td></tr>`;
            });
            html += `</tbody></table>`;
        }
        container.innerHTML = html;
    }

    // Initialize when Google Charts is ready, or fallback after timeout
    if (typeof google !== 'undefined' && google.charts) {
      google.charts.setOnLoadCallback(() => {
        updateStatus('Step 3.5: Google Charts loaded successfully!', 'green');
        init();
      });

      // Fallback if callback never fires
      setTimeout(() => {
        if (!allRes) {
          updateStatus('‚ö†Ô∏è TIMEOUT: Google Charts callback did not fire. Trying init anyway...', 'orange');
          init();
        }
      }, 5000);
    } else {
      updateStatus('‚ö†Ô∏è Google object not available. Starting without charts...', 'orange');
      setTimeout(init, 500);
    }

    window.addEventListener('resize', drawChart);
  </script>
</body>
</html>