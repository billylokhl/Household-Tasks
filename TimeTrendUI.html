<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root { --bg: #ffffff; --text: #333333; --border: #e2e8f0; }
    body.dark-mode { --bg: #0f172a; --text: #f1f5f9; --border: #334155; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; margin: 0; box-sizing: border-box; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
    .btn-group { display: flex; gap: 10px; }
    .btn { padding: 12px 24px; cursor: pointer; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; font-size: 18px; }
    .btn.active { background: #3b82f6; color: white; border-color: #2563eb; }
    #chart_div { flex-grow: 1; min-height: 400px; width: 100%; }
    /* Fix for Google's own tooltip container */
    .google-visualization-tooltip { border: none !important; background: transparent !important; box-shadow: none !important; }

    .chart-tooltip { padding: 12px; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-family: sans-serif; min-width: 200px; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5); }
    .chart-tooltip table { width: 100%; font-size: 12px; border-collapse: collapse; }
    .chart-tooltip td { padding: 2px 0; color: var(--text); }
    .chart-val { text-align: right; padding-left: 10px; }
    .chart-total { border-top: 1px solid var(--border); }
    .chart-pt { padding-top: 8px; }
  </style>
</head>
<body id="body">
  <div class="header">
    <div class="btn-group">
      <button id="btnA" class="btn active" onclick="switchOwner('A')">üê∑</button>
      <button id="btnB" class="btn" onclick="switchOwner('B')">üê±</button>
    </div>
    <button class="btn" style="font-size:14px" onclick="toggleTheme()">üåì Theme</button>
  </div>
  <div id="chart_div"></div>
  <div id="task_details_container" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px; overflow-y: auto; height: 150px;">
    <p style="color: var(--text); opacity: 0.7;">Hover over a bar to see task details.</p>
  </div>
  <script>
    google.charts.load('current', {'packages':['corechart']});
    let allRes = null, currentOwner = 'A', isDarkMode = false;

    function init() {
      google.script.run.withSuccessHandler(res => {
        if (res.error) { document.getElementById('chart_div').innerHTML = "Error: " + res.error; return; }
        allRes = res;
        drawChart();
      }).getTimeSpentData();
    }

    function switchOwner(o) {
      currentOwner = o;
      document.getElementById('btnA').classList.toggle('active', o === 'A');
      document.getElementById('btnB').classList.toggle('active', o === 'B');
      drawChart();
    }

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.getElementById('body').classList.toggle('dark-mode', isDarkMode);
      // Re-draw chart to update axes colors (client-side only now)
      drawChart();
    }

    function drawChart() {
      if (!allRes) return;

      const dataSet = currentOwner === 'A' ? allRes.dataA : allRes.dataB;
      const detailsSet = currentOwner === 'A' ? allRes.detailsA : allRes.detailsB;
      const categories = currentOwner === 'A' ? allRes.catsA : allRes.catsB;

      const data = google.visualization.arrayToDataTable(dataSet);
      const textColor = isDarkMode ? '#cbd5e1' : '#334155';
      const majorColor = isDarkMode ? '#94a3b8' : '#64748b'; // Thick/Dark for labeled
      const minorColor = isDarkMode ? '#1e293b' : '#e2e8f0'; // Thin/Light for unlabeled

      const options = {
        isStacked: true,
        backgroundColor: 'transparent',
        chartArea: { width: '85%', height: '60%', bottom: 120 },
        legend: { position: 'bottom', maxLines: 3, textStyle: { color: textColor, fontSize: 11 } },
        hAxis: { textStyle: { color: textColor, fontSize: 10 }, slantedText: true, slantedTextAngle: 45 },
        vAxis: {
            title: 'Minutes',
            textStyle: { color: textColor },
            gridlines: { color: majorColor },
            minorGridlines: { color: minorColor, count: 1 }
        },
        tooltip: { isHtml: true, trigger: 'both' }
      };

      const chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));

      google.visualization.events.addListener(chart, 'onmouseover', function(e) {
        if (e.row !== null && e.column !== null) {
           // row index corresponds to array position minus header, but data.getValue(row, 0) handles it via DataTable abstract
           const dateLabel = data.getValue(e.row, 0);

           // Columns are: Day, Cat0, Tooltip, Cat1, Tooltip...
           // So Cat Index = (Column Index - 1) / 2
           // e.g. Col 1 -> (1-1)/2 = 0. Col 3 -> (3-1)/2 = 1.
           const catIndex = Math.floor((e.column - 1) / 2);

           if (catIndex >= 0 && catIndex < categories.length) {
              const category = categories[catIndex];
              showTaskDetails(dateLabel, category, detailsSet);
           }
        }
      });

      chart.draw(data, options);
    }

    function showTaskDetails(date, category, details) {
        const container = document.getElementById('task_details_container');
        // details structure: { "DateLabel": { "CategoryName": [ {task, mins}, ... ] } }
        const dayData = details[date];
        const tasks = (dayData && dayData[category]) ? dayData[category] : [];

        let html = `<div style="font-weight: bold; margin-bottom: 8px;">${category} (${date})</div>`;
        if (tasks.length === 0) {
            html += '<div style="font-size: 13px;">No tasks recorded.</div>';
        } else {
            // Sort by mins desc
            tasks.sort((a,b) => b.mins - a.mins);

            html += `<table style="width:100%; border-collapse: collapse; font-size: 13px;">`;
            html += `<thead style="color: var(--text); border-bottom: 1px solid var(--border);"><tr><th style="padding:4px; text-align:left;">Task</th><th style="padding:4px; text-align:right;">Mins</th></tr></thead>`;
            html += `<tbody>`;
            tasks.forEach(t => {
               html += `<tr style="border-bottom: 1px solid var(--border);">
                          <td style="padding: 4px;">${t.task}</td>
                          <td style="padding: 4px; text-align: right;">${t.mins}</td>
                        </tr>`;
            });
            html += `</tbody></table>`;
        }
        container.innerHTML = html;
    }

    google.charts.setOnLoadCallback(init);
    window.addEventListener('resize', drawChart);
  </script>
</body>
</html>